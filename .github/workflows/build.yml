name: Build Thorium Multi-OS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- LE FIX POUR PYTHON (Tous les OS) ---
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --- SETUP DEPOT TOOLS (Nettoyage auto inclus) ---
      - name: Setup Depot Tools
        shell: bash
        run: |
          if [ -d "depot_tools" ]; then
            rm -rf depot_tools
          fi
          git clone --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "$GITHUB_WORKSPACE/depot_tools" >> $GITHUB_PATH

      # --- INSTALLATION DES DÉPENDANCES ---
      - name: Install System Dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 git curl build-essential lsb-release

      - name: Install System Dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          # On ne réinstalle pas Python ici ! 
          # Les runners Windows ont déjà Git et VS Build Tools.
          echo "Windows environment ready"

      # --- SYNC & BUILD ---
      - name: Fetch & Sync Thorium
        shell: bash
        run: |
          echo "Initialisation du build pour ${{ matrix.os }}..."
          # gclient sync ...
          echo "Syncing source code..."

      - name: Compile Thorium
        shell: bash
        run: |
          echo "Début de la compilation..."
          # ./thorium/build.sh
          echo "Build en cours..."

      # --- PACKAGING & UPLOAD ---
      - name: Package Artifacts
        shell: bash
        run: |
          mkdir -p output
          echo "Build finished on ${{ matrix.os }}" > output/status.txt

      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: Thorium-Build-${{ matrix.os }}
          path: output/
