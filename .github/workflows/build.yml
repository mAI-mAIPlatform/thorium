name: Build Thorium Multi-OS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # Pour ne pas tout stopper si un OS fail
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- SETUP DEPOT TOOLS (Fix du dossier existant inclus) ---
      - name: Setup Depot Tools
        shell: bash
        run: |
          if [ -d "depot_tools" ]; then
            echo "Nettoyage de l'ancien depot_tools..."
            rm -rf depot_tools
          fi
          git clone --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "$GITHUB_WORKSPACE/depot_tools" >> $GITHUB_PATH

      # --- INSTALLATION DES DÉPENDANCES ---
      - name: Install System Dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 git curl build-essential lsb-release

      - name: Install System Dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          # Windows a déjà la plupart des outils, mais Chromium a besoin de Python
          choco install python --version=3.11 -y

      # --- SYNC & BUILD (C'est là que la magie/douleur opère) ---
      - name: Fetch & Sync Thorium
        shell: bash
        run: |
          echo "Initialisation du build pour ${{ matrix.os }}..."
          # Ici tu devrais normalement faire un 'gclient config' et 'gclient sync'
          # Attention : C'est l'étape la plus longue et lourde.
          echo "Syncing source code..."

      - name: Compile Thorium
        shell: bash
        run: |
          echo "Début de la compilation..."
          # Commandes spécifiques Thorium (gn gen / ninja)
          # Exemple : ./thorium/build.sh
          echo "Build en cours..."

      # --- PACKAGING & UPLOAD ---
      - name: Package Artifacts
        shell: bash
        run: |
          mkdir -p output
          echo "Build terminé le $(date)" > output/build_info.txt
          # Ici, tu copies tes binaires (.exe, .dmg, .deb) dans le dossier output

      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: Thorium-Build-${{ matrix.os }}
          path: output/
